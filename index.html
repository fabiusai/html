<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>HTML Playground Pro + AI Tools 3.6</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/neo.min.css">
  
  <style>
    :root{
      --brand-blue: #0146bc;
      --brand-yellow: #eddc01;
      --brand-purple: #8a2be2; 
      --brand-blue-dark: #00338a;
      --bg: #f5f5f5;
      --card: #ffffff;
      --text-dark: #222222;
      --text-light: #5f6f81;
      --border-color: #e0e0e0;
      --radius: 8px;
      --mono: "Fira Code", "JetBrains Mono", Consolas, monospace;
      --ui-font: Inter, system-ui, -apple-system, sans-serif;
    }

    *{box-sizing:border-box}
    body{
      font-family: var(--ui-font);
      color: var(--text-dark);
      background: var(--bg);
      margin: 0;
      padding: 20px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-header{
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
      background: var(--card);
      padding: 12px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .logo{
      width: 40px;
      height: 40px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--brand-yellow);
    }
    .logo-icon { width: 24px; height: 24px; fill: var(--brand-blue); }
    h1{font-size: 18px; margin: 0; color: var(--brand-blue);}
    p.lead{margin: 0; color: var(--text-light); font-size: 12px;}

    .workspace {
      display: flex;
      flex: 1;
      gap: 0;
      overflow: hidden;
      min-height: 0;
    }

    .pane-editor {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      min-width: 300px;
      padding: 10px;
      overflow: hidden; 
    }

    .resizer {
      width: 12px;
      cursor: col-resize;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    .resizer:hover, .resizer.active { background: rgba(1, 70, 188, 0.1); }
    .resizer::after {
      content: "";
      width: 4px;
      height: 40px;
      background: var(--border-color);
      border-radius: 2px;
    }

    .pane-preview {
      width: 45%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 300px;
    }

    .preview-container {
      flex: 2;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow: hidden;
    }

    .console-container {
      flex: 1;
      background: #1e1e1e;
      border-radius: var(--radius);
      border: 1px solid var(--text-dark);
      display: flex;
      flex-direction: column;
      padding: 0;
      overflow: hidden;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .console-container .section-header {
      padding: 8px 10px;
      border-bottom: 1px solid #333;
      background: #252526;
      margin-bottom: 0;
    }
    .section-title h2{font-size: 14px; margin: 0; color: var(--brand-blue); display: flex; align-items: center; gap: 6px;}
    .console-container h2 { color: #ccc; }

    .CodeMirror {
      height: 100%;
      font-family: var(--mono);
      font-size: 13px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      flex-grow: 1;
    }
    .cm-s-neo.CodeMirror { background: #fff; color: #222; }

    .iframe-wrap { flex: 1; border: 1px solid var(--border-color); border-radius: 4px; background: #fff; position: relative;}
    iframe { width: 100%; height: 100%; border: 0; display: block; }
    
    #console-output {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      font-family: var(--mono);
      font-size: 12px;
      color: #ddd;
    }
    .log-entry { border-bottom: 1px solid #333; padding: 4px 0; white-space: pre-wrap; word-break: break-all; }
    .log-log { color: #ddd; }
    .log-warn { color: #eddc01; }
    .log-error { color: #ff6b6b; }
    .log-info { color: #61afef; }

    .search-controls { display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
    .search-controls input { flex-grow: 1; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px;}
    
    /* TOOLBAR AGGIORNATA */
    .toolbar { 
      display: flex; 
      gap: 6px; 
      flex-wrap: wrap; 
      margin-top: 8px; 
      align-items: center;
    }
    
    .btn{
      display: inline-flex; align-items: center; justify-content: center; gap: 4px;
      padding: 6px 10px; border-radius: 4px; border: 0; cursor: pointer;
      font-weight: 600; font-size: 12px; transition: filter 0.2s;
      position: relative; overflow: hidden; white-space: nowrap;
    }
    .btn:hover { filter: brightness(0.95); }
    .btn-blue{background: var(--brand-blue); color: white;}
    .btn-yellow{background: var(--brand-yellow); color: var(--brand-blue-dark);}
    .btn-purple{background: var(--brand-purple); color: white;} 
    .btn-ghost{background: transparent; border: 1px solid var(--border-color); color: var(--brand-blue);}
    .btn-tiny { padding: 4px 8px; font-size: 11px; height: 24px; }
    .btn-dark { background: #333; color: #fff; border: 1px solid #444; }
    .btn-danger { color: #ff6b6b; border: 1px solid #ff6b6b; background: transparent; }
    .btn svg { width: 14px; height: 14px; fill: currentColor; }

    .btn .feedback {
      position: absolute; inset: 0; background: inherit; display: flex; 
      align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .btn.loading .feedback { opacity: 1; }
    .btn.loading span:first-child { opacity: 0; }

    /* Gruppo File Ottimizzato */
    .file-group { 
      display: flex; 
      gap: 2px; 
      align-items: center; 
      background: #fff; 
      border: 1px solid var(--border-color); 
      border-radius: 4px; 
      padding: 1px; 
      margin-left: auto; 
    }
    .file-group input, .file-group select { border: none; font-size: 11px; padding: 4px; outline: none; background: transparent; }
    
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
      display: none; align-items: center; justify-content: center; z-index: 999;
    }
    .modal-content {
      background: var(--card); padding: 20px; border-radius: var(--radius); width: 700px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 12px;
      max-height: 90vh; overflow-y: auto;
    }
    textarea.patch-area {
      width: 100%; min-height: 100px; border: 1px solid var(--border-color);
      border-radius: 4px; padding: 8px; font-family: var(--mono); font-size: 12px; resize: vertical;
    }
    label { font-weight: 600; font-size: 12px; color: var(--brand-blue); display: block; margin-bottom: 4px; }
    
    /* Stili specifici per il tool AI */
    .ai-step { border: 1px solid var(--border-color); padding: 12px; border-radius: 4px; background: #fafafa; margin-bottom: 10px; }
    .ai-step h4 { margin: 0 0 8px 0; font-size: 13px; color: var(--text-dark); display: flex; justify-content: space-between; align-items: center; }
    .ai-log { background: #1e1e1e; color: #ccc; padding: 10px; font-family: var(--mono); font-size: 11px; max-height: 150px; overflow-y: auto; border-radius: 4px; margin-top: 8px; display: none; }
    .ai-log-item { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
    .ai-log-success { color: #61afef; }
    .ai-log-error { color: #ff6b6b; }

    /* Switch Style per AI e Patch */
    .switch-container { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-bottom: 8px; }
    .switch-container input { cursor: pointer; }
    .switch-container label { margin: 0; font-weight: normal; color: #333; cursor: pointer; }

    @media (max-width: 800px) {
      .workspace { flex-direction: column; overflow: auto; }
      .resizer { display: none; }
      .pane-preview { width: 100%; height: 500px; }
      .pane-editor { min-height: 400px; }
      .file-group { margin-left: 0; width: 100%; justify-content: space-between; }
    }
  </style>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
</head>
<body>

  <header class="app-header">
    <div class="logo"><svg class="logo-icon" viewBox="0 0 24 24"><path d="M11.24 2.37l-5.41 2.31L11.24 9.1v12.52l-7.6-3.26C3.25 18.15 3 17.8 3 17.41V6.13c0-.39.25-.74.64-.94l7.6-3.26c.26-.11.55-.11.8 0zM12.76 2.37l7.6 3.26c.39.2.64.55.64.94v11.28c0 .39-.25.74-.64.94l-7.6 3.26c-.26.11-.55-.11-.8 0V9.1l5.41-4.42-5.41-2.31z"></path></svg></div>
    <div>
      <h1>Editor HTML Pro + AI Tools</h1>
      <p class="lead">Editor Completo con Auto-save, Live Preview e Refactoring AI.</p>
    </div>
  </header>

  <div class="workspace" id="workspace">
    
    <div class="pane-editor" id="paneEditor">
      <div class="section-header">
        <div class="section-title"><h2><svg viewBox="0 0 20 20"><path fill="currentColor" d="M12.3 3.7l4 4L4 20H0v-4L12.3 3.7zm1.4-1.4L16 0l4 4L17.7 4.6 13.7 2.3z"/></svg> Codice Sorgente</h2></div>
        <div style="font-size: 11px; color: var(--text-light);" id="saveStatus">Salvato</div>
      </div>

      <div class="search-controls">
        <input type="text" id="findInput" placeholder="Cerca...">
        <button id="findBtn" class="btn btn-tiny btn-ghost">Trova</button>
        <input type="text" id="replaceInput" placeholder="Sostituisci...">
        <button id="replaceBtn" class="btn btn-tiny btn-ghost">Sostituisci</button>
        <button id="replaceAllBtn" class="btn btn-tiny btn-ghost">Tutti</button>
      </div>

      <textarea id="code" name="code"></textarea>

      <div class="toolbar">
        <button id="copyBtn" class="btn btn-yellow" title="Copia Codice"><span>Copia</span><span class="feedback"></span></button>
        <button id="pasteBtn" class="btn btn-ghost" title="Incolla Codice (Sostituisce Tutto)"><span>Incolla</span><span class="feedback"></span></button>
        <button id="clearBtn" class="btn btn-ghost" title="Pulisci Editor"><span>Pulisci</span><span class="feedback"></span></button>
        
        <div style="width:1px; height:20px; background:var(--border-color); margin:0 4px;"></div>
        
        <button id="patchBtn" class="btn btn-ghost" title="Patch Manuale"><span>Patch</span><span class="feedback"></span></button>
        <button id="aiToolBtn" class="btn btn-purple"><span>✨ AI Tool</span><span class="feedback"></span></button>
        
        <div class="file-group">
          <button id="importBtn" class="btn btn-ghost btn-tiny" title="Importa File" style="border:none; border-right:1px solid #eee;"><svg viewBox="0 0 24 24" style="width:16px;height:16px"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg></button>
          <input type="text" id="filename" value="progetto" placeholder="Nome" style="width:70px">
          <select id="fileExtension" style="width:50px">
            <option value=".html">.html</option>
            <option value=".css">.css</option>
            <option value=".js">.js</option>
            <option value=".json">.json</option>
            <option value=".xml">.xml</option>
            <option value=".txt">.txt</option>
          </select>
          <button id="downloadBtn" class="btn btn-blue btn-tiny" style="border-radius:0 4px 4px 0;">Salva</button>
        </div>
        
        <input type="file" id="fileInput" style="display:none">
      </div>
    </div>

    <div class="resizer" id="resizer"></div>

    <div class="pane-preview" id="panePreview">
      
      <div class="preview-container">
        <div class="section-header">
          <div class="section-title"><h2><svg viewBox="0 0 20 20"><path fill="currentColor" d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg> Anteprima Live</h2></div>
          <div style="display:flex; gap:6px">
            <button id="refreshBtn" class="btn btn-tiny btn-ghost">Ricarica</button>
            <button id="newTabBtn" class="btn btn-tiny btn-ghost">Nuova Tab</button>
          </div>
        </div>
        <div class="iframe-wrap">
          <iframe id="preview" sandbox="allow-scripts allow-modals allow-forms allow-popups allow-same-origin"></iframe>
        </div>
      </div>

      <div class="console-container">
        <div class="section-header">
          <div class="section-title"><h2><svg viewBox="0 0 20 20" style="fill:#ccc"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 19V7H4v12h16zM4 5h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V7c0-1.1.9-2 2-2zm0-2h16V2H4v1z"/></svg> Console JS</h2></div>
          <button id="clearConsoleBtn" class="btn btn-tiny btn-dark">Pulisci</button>
        </div>
        <div id="console-output">
          <div style="color: #666; font-style: italic;">In attesa di log...</div>
        </div>
      </div>

    </div>
  </div>

  <div id="patchModal" class="modal-overlay">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:var(--brand-blue)">Patch Manuale Intelligente</h3>
        <button id="copyPatchPromptBtn" class="btn btn-tiny btn-purple" title="Copia istruzioni per AI">Copia Prompt x AI</button>
      </div>
      <p class="lead">Incolla il blocco vecchio (ricerca flessibile su spazi/maiuscole) e il nuovo codice.</p>
      
      <div style="margin-bottom:8px;">
        <label>Istruzioni / Contesto (Opzionale per Prompt AI):</label>
        <textarea id="patchInstructions" class="patch-area" style="height:45px; min-height:45px;" placeholder="Es. 'Cerca la funzione di Login e modificala per...'"></textarea>
      </div>
      
      <div class="switch-container" style="margin-bottom:12px;">
        <input type="checkbox" id="patchIncludeCodeToggle" checked>
        <label for="patchIncludeCodeToggle">Includi tutto il codice sorgente nel Prompt (Deseleziona se allegato)</label>
      </div>

      <div id="patchStatus" style="font-size: 13px; font-weight: bold; min-height: 20px; padding:4px 0;"></div>

      <div style="position:relative;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
          <label>Codice da trovare (Vecchio):</label>
          <button id="clearPatchFieldsBtn" class="btn btn-tiny btn-ghost" style="margin-bottom:2px;">Svuota Campi</button>
        </div>
        <textarea id="patchOld" class="patch-area" spellcheck="false" placeholder="Incolla qui il codice presente nell'editor..."></textarea>
      </div>
      <div>
        <label>Sostituisci con (Nuovo):</label>
        <textarea id="patchNew" class="patch-area" spellcheck="false" placeholder="Incolla qui il nuovo codice..."></textarea>
      </div>
      
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px">
        <button id="undoPatchBtn" class="btn btn-danger btn-tiny" style="display:none">Annulla Patch</button>
        <button id="closePatchBtn" class="btn btn-ghost">Chiudi</button>
        <button id="applyPatchBtn" class="btn btn-blue">Applica Patch</button>
      </div>
    </div>
  </div>

  <div id="aiModal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin:0; color:var(--brand-purple)">AI Multi-Patch Tool 3.3 (Secure)</h3>
      <p class="lead">Sistema immune a virgolette e markdown. Usa il formato @@@.</p>
      
      <div class="ai-step">
        <h4>1. Istruisci l'AI</h4>
        <textarea id="aiUserInstructions" class="patch-area" placeholder="Descrivi qui le modifiche che vuoi fare al codice (es. 'Cambia lo sfondo in rosso')..." style="height:60px; min-height:60px; margin-bottom:8px;"></textarea>
        
        <div class="switch-container">
          <input type="checkbox" id="includeCodeToggle" checked>
          <label for="includeCodeToggle">Includi il codice sorgente nel testo del Prompt (Deseleziona se alleghi file esterno)</label>
        </div>

        <button id="copyPromptBtn" class="btn btn-tiny btn-purple" style="width:100%">Copia Prompt Completo</button>
        <p style="font-size:12px; margin-top:6px; color:#666;">Il prompt includerà le tue istruzioni e un avviso di sicurezza assoluto per l'integrità.</p>
      </div>

      <div class="ai-step">
        <h4>2. Incolla Risposta AI <span style="font-size:11px; font-weight:normal; color:#888;">(o trascina testo qui)</span></h4>
        <textarea id="aiInput" class="patch-area" placeholder="Incolla qui la risposta dell'AI contenente i blocchi @@@ FIND @@@..." spellcheck="false"></textarea>
        <div id="aiLog" class="ai-log"></div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:0px">
        <button id="closeAiBtn" class="btn btn-ghost">Chiudi</button>
        <button id="applyAiBtn" class="btn btn-purple">Applica Modifiche AI</button>
      </div>
    </div>
  </div>

<script>
  var editor;
  var lastContentBeforePatch = null;
  const STORAGE_KEY = 'html_playground_content';
  
  window.onload = function() {
    editor = CodeMirror.fromTextArea(document.getElementById("code"), {
      mode: "htmlmixed",
      theme: "neo",
      lineNumbers: true,
      lineWrapping: true,
      autofocus: true
    });

    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved) {
      editor.setValue(saved);
    } else {
      editor.setValue(getDefaultTemplate());
    }

    editor.on("change", () => {
      saveToStorage();
      debouncedPreview();
    });

    updatePreview();
    setupResizer();
  };

  function getDefaultTemplate() {
    return `<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: sans-serif; padding: 20px; color: #333; }\n    h1 { color: #0146bc; }\n    .card { background: #eee; padding: 15px; border-radius: 8px; }\n  </style>\n</head>\n<body>\n  <h1>Ciao Mondo!</h1>\n  <div class="card">\n    <p>Prova a modificare questo testo o lo stile CSS.</p>\n    <button onclick="console.log('Click bottone: ' + new Date().toLocaleTimeString())">\n      Testa Console\n    </button>\n  </div>\n</body>\n</html>`;
  }

  function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, editor.getValue());
    const status = document.getElementById('saveStatus');
    status.textContent = 'Salvando...';
    setTimeout(() => status.textContent = 'Salvato', 500);
  }

  let debounceTimer;
  function debouncedPreview() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(updatePreview, 600); 
  }

  function updatePreview() {
    const previewFrame = document.getElementById('preview');
    if (!previewFrame) return;

    const code = editor.getValue();
    const consoleInterceptor = `\n<script>\n(function(){\n  function send(type, args){\n    try { window.parent.postMessage({source: 'playground-console', type: type, args: Array.from(args).map(a => String(a))}, '*'); } catch(e){}\n  }\n  const originalLog = console.log; console.log = function(...args){ originalLog.apply(console, args); send('log', args); };\n  const originalWarn = console.warn; console.warn = function(...args){ originalWarn.apply(console, args); send('warn', args); };\n  const originalError = console.error; console.error = function(...args){ originalError.apply(console, args); send('error', args); };\n  window.onerror = function(msg, url, line){ send('error', [msg + " (Line: " + line + ")"]); };\n})();\n<\/script>\n`;
    
    let finalHtml;
    const headRegex = /<head\b[^>]*>/i;
    
    if (headRegex.test(code)) {
      finalHtml = code.replace(headRegex, (match) => match + consoleInterceptor);
    } else {
      finalHtml = consoleInterceptor + code;
    }
    
    const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
    doc.open();
    doc.write(finalHtml);
    doc.close();
  }

  const consoleOutput = document.getElementById('console-output');
  window.addEventListener('message', (event) => {
    if (event.data && event.data.source === 'playground-console') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${event.data.type}`;
      entry.textContent = `[${new Date().toLocaleTimeString().split(' ')[0]}] > ${event.data.args.join(' ')}`;
      consoleOutput.appendChild(entry);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }
  });

  document.getElementById('clearConsoleBtn').onclick = () => consoleOutput.innerHTML = '';
  document.getElementById('refreshBtn').onclick = () => updatePreview();

  function showFeedback(btn, text) {
    const fb = btn.querySelector('.feedback');
    if(fb) {
      fb.textContent = text;
      btn.classList.add('loading');
      setTimeout(() => btn.classList.remove('loading'), 1500);
    }
  }

  document.getElementById('copyBtn').onclick = function() {
    navigator.clipboard.writeText(editor.getValue());
    showFeedback(this, 'Copiato!');
  };

  document.getElementById('pasteBtn').onclick = async function() {
    try {
      const text = await navigator.clipboard.readText();
      editor.setValue(text); // MODIFICATO: Sostituisce tutto invece di appendere
      showFeedback(this, 'Sostituito!');
    } catch (err) {
      console.error(err);
      alert('Impossibile accedere agli appunti. Consenti l\'accesso o usa Ctrl+V.');
    }
  };

  document.getElementById('newTabBtn').onclick = function() {
    const blob = new Blob([editor.getValue()], {type: 'text/html'});
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
  };

  document.getElementById('findBtn').onclick = function() {
    const query = document.getElementById('findInput').value;
    if(!query) return;
    let cursor = editor.getSearchCursor(query, editor.getCursor("to"));
    if (!cursor.findNext()) {
      cursor = editor.getSearchCursor(query, {line: 0, ch: 0});
      if (!cursor.findNext()) { showFeedback(this, 'Nessun risultato'); return; }
    }
    editor.setSelection(cursor.from(), cursor.to());
    const h = editor.getScrollInfo().clientHeight;
    const coords = editor.charCoords(cursor.from(), "local");
    editor.scrollTo(null, (coords.top + coords.bottom) / 2 - h / 2);
    editor.focus();
    showFeedback(this, 'Trovato');
  };

  document.getElementById('replaceBtn').onclick = function() {
    const query = document.getElementById('findInput').value;
    const replacement = document.getElementById('replaceInput').value;
    if(editor.getSelection() === query) {
      editor.replaceSelection(replacement);
      document.getElementById('findBtn').click();
    } else {
      document.getElementById('findBtn').click();
    }
  };

  // --- LOGICA MODALE PATCH MANUALE (AGGIORNATA) ---
  const patchModal = document.getElementById('patchModal');
  const patchStatus = document.getElementById('patchStatus');
  const undoPatchBtn = document.getElementById('undoPatchBtn');
  const patchOldInput = document.getElementById('patchOld');
  const patchNewInput = document.getElementById('patchNew');
  const patchInstructionsInput = document.getElementById('patchInstructions');
  const patchIncludeCodeToggle = document.getElementById('patchIncludeCodeToggle'); // NUOVO

  document.getElementById('patchBtn').onclick = () => {
    patchModal.style.display = 'flex';
    patchStatus.textContent = '';
    undoPatchBtn.style.display = 'none';
    patchInstructionsInput.value = '';
    patchOldInput.focus();
  };

  document.getElementById('closePatchBtn').onclick = () => patchModal.style.display = 'none';

  // Funzione helper per creare Regex "Fuzzy" (ignora spazi multipli/a capo e case sensitive)
  function createFuzzyRegex(text) {
    const escaped = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const pattern = escaped.replace(/\s+/g, '\\s+');
    return new RegExp(pattern, 'i'); 
  }

  patchOldInput.addEventListener('input', function() {
    const val = this.value.trim();
    if(!val) {
      patchStatus.textContent = '';
      return;
    }
    
    const currentContent = editor.getValue();
    const regex = createFuzzyRegex(val);

    if(regex.test(currentContent)) {
      patchStatus.style.color = "green";
      patchStatus.innerHTML = "✔ <b>Trovato!</b> Corrispondenza rilevata nel codice.";
    } else {
      patchStatus.style.color = "red";
      patchStatus.innerHTML = "✖ <b>Non trovato.</b> Verifica il codice incollato.";
    }
  });

  document.getElementById('clearPatchFieldsBtn').onclick = function() {
    patchOldInput.value = '';
    patchNewInput.value = '';
    patchInstructionsInput.value = '';
    patchStatus.textContent = '';
    patchOldInput.focus();
  };

  // 4) Copia Prompt AI specifico per Patch Manuale (AGGIORNATO CON TOGGLE)
  document.getElementById('copyPatchPromptBtn').onclick = function() {
    const instructions = patchInstructionsInput.value.trim();
    const includeCode = patchIncludeCodeToggle.checked;
    const currentCode = editor.getValue();

    let codeBlock = "";
    if(includeCode) {
        codeBlock = `CODICE SORGENTE COMPLETO:\n---\n${currentCode}\n---`;
    } else {
        codeBlock = `[[ IL CODICE SORGENTE È STATO ALLEGATO COME FILE ESTERNO ]]`;
    }

    const extraContext = instructions ? `\n\nCONTESTO/MODIFICHE RICHIESTE:\n${instructions}` : "";

    const promptText = `Ho bisogno di fare una modifica manuale precisa al codice.${extraContext}

${codeBlock}

Per favore analizza il codice e forniscimi SOLO due blocchi di codice per effettuare la sostituzione:
1. Il blocco ESATTO di codice originale presente nel sorgente che devo cercare (deve essere univoco, includi contesto se necessario).
2. Il NUOVO blocco di codice con cui devo sostituirlo.
Non aggiungere spiegazioni, solo i due blocchi.

[[ IMPORTANTE: NON MODIFICARE, RIDURRE O ALTERARE NESSUNA ALTRA PARTE DEL CODICE ]]`;
    
    navigator.clipboard.writeText(promptText);
    const originalText = this.textContent;
    this.textContent = "Copiato!";
    setTimeout(() => this.textContent = originalText, 2000);
  };
  
  document.getElementById('applyPatchBtn').onclick = function() {
    const oldCodeVal = patchOldInput.value.trim();
    const newCode = patchNewInput.value; 
    const currentContent = editor.getValue();
    
    if (oldCodeVal === "") {
      patchStatus.style.color = "red";
      patchStatus.textContent = "Errore: Inserisci il codice da trovare.";
      return;
    }

    const regex = createFuzzyRegex(oldCodeVal);

    if(regex.test(currentContent)) {
      lastContentBeforePatch = currentContent;
      const updatedContent = currentContent.replace(regex, newCode);
      editor.setValue(updatedContent);
      
      patchStatus.style.color = "green";
      patchStatus.innerHTML = "✔ <b>Patch applicata!</b> I campi sono stati svuotati.";
      undoPatchBtn.style.display = 'inline-flex';
      
      patchOldInput.value = ''; 
      patchNewInput.value = '';
      patchInstructionsInput.value = '';
    } else {
      patchStatus.style.color = "red";
      patchStatus.textContent = "✖ Blocco non trovato (nemmeno con ricerca flessibile).";
    }
  };

  undoPatchBtn.onclick = function() {
    if(lastContentBeforePatch !== null) {
      editor.setValue(lastContentBeforePatch);
      lastContentBeforePatch = null;
      patchStatus.style.color = "orange";
      patchStatus.textContent = "Operazione annullata.";
      this.style.display = 'none';
    }
  };

  // --- LOGICA NUOVA MODALE AI TOOLS 3.3 (Secure) ---
  const aiModal = document.getElementById('aiModal');
  const aiLog = document.getElementById('aiLog');

  document.getElementById('aiToolBtn').onclick = () => {
    aiModal.style.display = 'flex';
    aiLog.style.display = 'none';
    aiLog.innerHTML = '';
    document.getElementById('aiInput').value = '';
  };
  
  document.getElementById('closeAiBtn').onclick = () => aiModal.style.display = 'none';

  // 1. GENERATORE DI PROMPT 3.0 (Include istruzioni utente e avviso integrità)
  document.getElementById('copyPromptBtn').onclick = function() {
    const currentCode = editor.getValue();
    const userInstructions = document.getElementById('aiUserInstructions').value.trim();
    const includeCode = document.getElementById('includeCodeToggle').checked;
    
    let codeBlock = "";
    if(includeCode) {
        codeBlock = `CODICE SORGENTE:\n---\n${currentCode}\n---`;
    } else {
        codeBlock = `[[ IL CODICE SORGENTE È STATO ALLEGATO COME FILE ESTERNO ]]`;
    }

    const prompt = `Agisci come un esperto sviluppatore. Ho bisogno di modifiche al codice.

***MODIFICHE RICHIESTE***
${userInstructions ? userInstructions : "Attenzione: Nessuna istruzione specifica fornita. Migliora il codice esistente."}

***IMPERATIVO ASSOLUTO SULL'INTEGRITÀ***
Esegui SOLO ed ESCLUSIVAMENTE le modifiche richieste sopra.
NON modificare, NON ridurre, NON semplificare e NON rifattorizzare nessuna altra parte del codice.
L'applicazione deve rimanere identica tranne che per i punti specificati.

***FORMATO RISPOSTA (Obbligatorio)***
Usa SOLO questo formato personalizzato per la risposta. 
NON usare blocchi Markdown (\`\`\`) e NON usare JSON.

FORMATO RICHIESTO:
@@@ FIND @@@
[Qui incolla il codice esatto da sostituire]
@@@ REPLACE @@@
[Qui incolla il nuovo codice]
@@@ END @@@

Se ci sono più modifiche, ripeti il blocco.

${codeBlock}

Attendo le modifiche nel formato @@@ FIND @@@...`;

    navigator.clipboard.writeText(prompt);
    showFeedback(this, 'Prompt Copiato!');
    alert("Prompt copiato!\nInclude istruzioni, codice (o placeholder) e avviso di integrità severo.");
  };

  // 2. APPLICAZIONE PATCH 3.0 (SAFE BLOCKS)
  document.getElementById('applyAiBtn').onclick = function() {
    let rawInput = document.getElementById('aiInput').value;
    aiLog.style.display = 'block';
    aiLog.innerHTML = '';
    
    function log(msg, type='info') {
      const div = document.createElement('div');
      div.className = 'ai-log-item ' + (type === 'success' ? 'ai-log-success' : type === 'error' ? 'ai-log-error' : '');
      div.textContent = msg;
      aiLog.appendChild(div);
    }

    rawInput = rawInput.replace(/```html/gi, '').replace(/```/g, '');

    const regex = /@@@ FIND @@@\s*([\s\S]*?)\s*@@@ REPLACE @@@\s*([\s\S]*?)\s*@@@ END @@@/g;
    
    let match;
    let patches = [];
    while ((match = regex.exec(rawInput)) !== null) {
      patches.push({ find: match[1], replace: match[2] });
    }

    if (patches.length === 0) {
      log("ERRORE: Nessun blocco @@@ trovato. Assicurati di usare il prompt corretto.", "error");
      return;
    }

    let content = editor.getValue();
    let appliedCount = 0;
    let failedCount = 0;

    patches.forEach((patch, index) => {
      const findText = patch.find.replace(/^\n/, '').replace(/\n$/, ''); 
      const replaceText = patch.replace.replace(/^\n/, '').replace(/\n$/, '');

      if (content.includes(findText)) {
        content = content.replace(findText, replaceText);
        log(`Patch #${index+1}: Applicata correttamente.`, "success");
        appliedCount++;
      } else {
        if (content.includes(patch.find.trim())) {
           content = content.replace(patch.find.trim(), replaceText);
           log(`Patch #${index+1}: Applicata (con trim).`, "success");
           appliedCount++;
        } else {
           log(`Patch #${index+1}: FALLITA. Codice originale non trovato.`, "error");
           console.warn("Cercavo:\n", findText);
           failedCount++;
        }
      }
    });

    if (appliedCount > 0) {
      editor.setValue(content);
      log(`COMPLETATO: ${appliedCount} modifiche applicate.`, "success");
      saveToStorage();
    } else {
      log("Nessuna modifica applicata. Apri la console (F12) per i dettagli.", "error");
    }
  };

  const dropArea = document.getElementById('aiInput');
  dropArea.addEventListener('dragover', (e) => { e.stopPropagation(); e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; dropArea.style.borderColor = 'var(--brand-purple)'; });
  dropArea.addEventListener('dragleave', (e) => { dropArea.style.borderColor = 'var(--border-color)'; });
  dropArea.addEventListener('drop', (e) => {
    e.stopPropagation(); e.preventDefault();
    dropArea.style.borderColor = 'var(--border-color)';
    const file = e.dataTransfer.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (evt) => { document.getElementById('aiInput').value = evt.target.result; };
      reader.readAsText(file);
    }
  });

  document.getElementById('clearBtn').onclick = () => confirm('Cancellare tutto?') && editor.setValue('');
  
  const extSelect = document.getElementById('fileExtension');
  
  document.getElementById('downloadBtn').onclick = function() {
    const blob = new Blob([editor.getValue()], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    let extension = extSelect.value;
    a.download = (document.getElementById('filename').value || 'progetto') + extension;
    a.click();
  };

  document.getElementById('importBtn').onclick = () => document.getElementById('fileInput').click();
  document.getElementById('fileInput').onchange = (e) => {
    const file = e.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = (ev) => editor.setValue(ev.target.result);
      reader.readAsText(file);
    }
  };

  function setupResizer() {
    const resizer = document.getElementById('resizer'), ep = document.getElementById('paneEditor'), pp = document.getElementById('panePreview');
    let isResizing = false;
    resizer.onmousedown = (e) => { isResizing = true; document.body.style.cursor = 'col-resize'; e.preventDefault(); };
    document.onmousemove = (e) => {
      if (!isResizing) return;
      const w = document.getElementById('workspace').offsetWidth - e.clientX;
      if (e.clientX > 300 && w > 300) { ep.style.flex = '1'; pp.style.width = w + 'px'; pp.style.flex = 'none'; }
    };
    document.onmouseup = () => { isResizing = false; document.body.style.cursor = 'default'; editor.refresh(); };
  }
</script>
</body>
</html><!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>HTML Playground Pro + AI Tools 3.6</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/neo.min.css">
  
  <style>
    :root{
      --brand-blue: #0146bc;
      --brand-yellow: #eddc01;
      --brand-purple: #8a2be2; 
      --brand-blue-dark: #00338a;
      --bg: #f5f5f5;
      --card: #ffffff;
      --text-dark: #222222;
      --text-light: #5f6f81;
      --border-color: #e0e0e0;
      --radius: 8px;
      --mono: "Fira Code", "JetBrains Mono", Consolas, monospace;
      --ui-font: Inter, system-ui, -apple-system, sans-serif;
    }

    *{box-sizing:border-box}
    body{
      font-family: var(--ui-font);
      color: var(--text-dark);
      background: var(--bg);
      margin: 0;
      padding: 20px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-header{
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
      background: var(--card);
      padding: 12px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .logo{
      width: 40px;
      height: 40px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--brand-yellow);
    }
    .logo-icon { width: 24px; height: 24px; fill: var(--brand-blue); }
    h1{font-size: 18px; margin: 0; color: var(--brand-blue);}
    p.lead{margin: 0; color: var(--text-light); font-size: 12px;}

    .workspace {
      display: flex;
      flex: 1;
      gap: 0;
      overflow: hidden;
      min-height: 0;
    }

    .pane-editor {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      min-width: 300px;
      padding: 10px;
      overflow: hidden; 
    }

    .resizer {
      width: 12px;
      cursor: col-resize;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    .resizer:hover, .resizer.active { background: rgba(1, 70, 188, 0.1); }
    .resizer::after {
      content: "";
      width: 4px;
      height: 40px;
      background: var(--border-color);
      border-radius: 2px;
    }

    .pane-preview {
      width: 45%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 300px;
    }

    .preview-container {
      flex: 2;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow: hidden;
    }

    .console-container {
      flex: 1;
      background: #1e1e1e;
      border-radius: var(--radius);
      border: 1px solid var(--text-dark);
      display: flex;
      flex-direction: column;
      padding: 0;
      overflow: hidden;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .console-container .section-header {
      padding: 8px 10px;
      border-bottom: 1px solid #333;
      background: #252526;
      margin-bottom: 0;
    }
    .section-title h2{font-size: 14px; margin: 0; color: var(--brand-blue); display: flex; align-items: center; gap: 6px;}
    .console-container h2 { color: #ccc; }

    .CodeMirror {
      height: 100%;
      font-family: var(--mono);
      font-size: 13px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      flex-grow: 1;
    }
    .cm-s-neo.CodeMirror { background: #fff; color: #222; }

    .iframe-wrap { flex: 1; border: 1px solid var(--border-color); border-radius: 4px; background: #fff; position: relative;}
    iframe { width: 100%; height: 100%; border: 0; display: block; }
    
    #console-output {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      font-family: var(--mono);
      font-size: 12px;
      color: #ddd;
    }
    .log-entry { border-bottom: 1px solid #333; padding: 4px 0; white-space: pre-wrap; word-break: break-all; }
    .log-log { color: #ddd; }
    .log-warn { color: #eddc01; }
    .log-error { color: #ff6b6b; }
    .log-info { color: #61afef; }

    .search-controls { display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
    .search-controls input { flex-grow: 1; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px;}
    
    /* TOOLBAR AGGIORNATA */
    .toolbar { 
      display: flex; 
      gap: 6px; 
      flex-wrap: wrap; 
      margin-top: 8px; 
      align-items: center;
    }
    
    .btn{
      display: inline-flex; align-items: center; justify-content: center; gap: 4px;
      padding: 6px 10px; border-radius: 4px; border: 0; cursor: pointer;
      font-weight: 600; font-size: 12px; transition: filter 0.2s;
      position: relative; overflow: hidden; white-space: nowrap;
    }
    .btn:hover { filter: brightness(0.95); }
    .btn-blue{background: var(--brand-blue); color: white;}
    .btn-yellow{background: var(--brand-yellow); color: var(--brand-blue-dark);}
    .btn-purple{background: var(--brand-purple); color: white;} 
    .btn-ghost{background: transparent; border: 1px solid var(--border-color); color: var(--brand-blue);}
    .btn-tiny { padding: 4px 8px; font-size: 11px; height: 24px; }
    .btn-dark { background: #333; color: #fff; border: 1px solid #444; }
    .btn-danger { color: #ff6b6b; border: 1px solid #ff6b6b; background: transparent; }
    .btn svg { width: 14px; height: 14px; fill: currentColor; }

    .btn .feedback {
      position: absolute; inset: 0; background: inherit; display: flex; 
      align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .btn.loading .feedback { opacity: 1; }
    .btn.loading span:first-child { opacity: 0; }

    /* Gruppo File Ottimizzato */
    .file-group { 
      display: flex; 
      gap: 2px; 
      align-items: center; 
      background: #fff; 
      border: 1px solid var(--border-color); 
      border-radius: 4px; 
      padding: 1px; 
      margin-left: auto; 
    }
    .file-group input, .file-group select { border: none; font-size: 11px; padding: 4px; outline: none; background: transparent; }
    
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
      display: none; align-items: center; justify-content: center; z-index: 999;
    }
    .modal-content {
      background: var(--card); padding: 20px; border-radius: var(--radius); width: 700px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 12px;
      max-height: 90vh; overflow-y: auto;
    }
    textarea.patch-area {
      width: 100%; min-height: 100px; border: 1px solid var(--border-color);
      border-radius: 4px; padding: 8px; font-family: var(--mono); font-size: 12px; resize: vertical;
    }
    label { font-weight: 600; font-size: 12px; color: var(--brand-blue); display: block; margin-bottom: 4px; }
    
    /* Stili specifici per il tool AI */
    .ai-step { border: 1px solid var(--border-color); padding: 12px; border-radius: 4px; background: #fafafa; margin-bottom: 10px; }
    .ai-step h4 { margin: 0 0 8px 0; font-size: 13px; color: var(--text-dark); display: flex; justify-content: space-between; align-items: center; }
    .ai-log { background: #1e1e1e; color: #ccc; padding: 10px; font-family: var(--mono); font-size: 11px; max-height: 150px; overflow-y: auto; border-radius: 4px; margin-top: 8px; display: none; }
    .ai-log-item { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
    .ai-log-success { color: #61afef; }
    .ai-log-error { color: #ff6b6b; }

    /* Switch Style per AI e Patch */
    .switch-container { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-bottom: 8px; }
    .switch-container input { cursor: pointer; }
    .switch-container label { margin: 0; font-weight: normal; color: #333; cursor: pointer; }

    @media (max-width: 800px) {
      .workspace { flex-direction: column; overflow: auto; }
      .resizer { display: none; }
      .pane-preview { width: 100%; height: 500px; }
      .pane-editor { min-height: 400px; }
      .file-group { margin-left: 0; width: 100%; justify-content: space-between; }
    }
  </style>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
</head>
<body>

  <header class="app-header">
    <div class="logo"><svg class="logo-icon" viewBox="0 0 24 24"><path d="M11.24 2.37l-5.41 2.31L11.24 9.1v12.52l-7.6-3.26C3.25 18.15 3 17.8 3 17.41V6.13c0-.39.25-.74.64-.94l7.6-3.26c.26-.11.55-.11.8 0zM12.76 2.37l7.6 3.26c.39.2.64.55.64.94v11.28c0 .39-.25.74-.64.94l-7.6 3.26c-.26.11-.55-.11-.8 0V9.1l5.41-4.42-5.41-2.31z"></path></svg></div>
    <div>
      <h1>Editor HTML Pro + AI Tools</h1>
      <p class="lead">Editor Completo con Auto-save, Live Preview e Refactoring AI.</p>
    </div>
  </header>

  <div class="workspace" id="workspace">
    
    <div class="pane-editor" id="paneEditor">
      <div class="section-header">
        <div class="section-title"><h2><svg viewBox="0 0 20 20"><path fill="currentColor" d="M12.3 3.7l4 4L4 20H0v-4L12.3 3.7zm1.4-1.4L16 0l4 4L17.7 4.6 13.7 2.3z"/></svg> Codice Sorgente</h2></div>
        <div style="font-size: 11px; color: var(--text-light);" id="saveStatus">Salvato</div>
      </div>

      <div class="search-controls">
        <input type="text" id="findInput" placeholder="Cerca...">
        <button id="findBtn" class="btn btn-tiny btn-ghost">Trova</button>
        <input type="text" id="replaceInput" placeholder="Sostituisci...">
        <button id="replaceBtn" class="btn btn-tiny btn-ghost">Sostituisci</button>
        <button id="replaceAllBtn" class="btn btn-tiny btn-ghost">Tutti</button>
      </div>

      <textarea id="code" name="code"></textarea>

      <div class="toolbar">
        <button id="copyBtn" class="btn btn-yellow" title="Copia Codice"><span>Copia</span><span class="feedback"></span></button>
        <button id="pasteBtn" class="btn btn-ghost" title="Incolla Codice (Sostituisce Tutto)"><span>Incolla</span><span class="feedback"></span></button>
        <button id="clearBtn" class="btn btn-ghost" title="Pulisci Editor"><span>Pulisci</span><span class="feedback"></span></button>
        
        <div style="width:1px; height:20px; background:var(--border-color); margin:0 4px;"></div>
        
        <button id="patchBtn" class="btn btn-ghost" title="Patch Manuale"><span>Patch</span><span class="feedback"></span></button>
        <button id="aiToolBtn" class="btn btn-purple"><span>✨ AI Tool</span><span class="feedback"></span></button>
        
        <div class="file-group">
          <button id="importBtn" class="btn btn-ghost btn-tiny" title="Importa File" style="border:none; border-right:1px solid #eee;"><svg viewBox="0 0 24 24" style="width:16px;height:16px"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg></button>
          <input type="text" id="filename" value="progetto" placeholder="Nome" style="width:70px">
          <select id="fileExtension" style="width:50px">
            <option value=".html">.html</option>
            <option value=".css">.css</option>
            <option value=".js">.js</option>
            <option value=".json">.json</option>
            <option value=".xml">.xml</option>
            <option value=".txt">.txt</option>
          </select>
          <button id="downloadBtn" class="btn btn-blue btn-tiny" style="border-radius:0 4px 4px 0;">Salva</button>
        </div>
        
        <input type="file" id="fileInput" style="display:none">
      </div>
    </div>

    <div class="resizer" id="resizer"></div>

    <div class="pane-preview" id="panePreview">
      
      <div class="preview-container">
        <div class="section-header">
          <div class="section-title"><h2><svg viewBox="0 0 20 20"><path fill="currentColor" d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg> Anteprima Live</h2></div>
          <div style="display:flex; gap:6px">
            <button id="refreshBtn" class="btn btn-tiny btn-ghost">Ricarica</button>
            <button id="newTabBtn" class="btn btn-tiny btn-ghost">Nuova Tab</button>
          </div>
        </div>
        <div class="iframe-wrap">
          <iframe id="preview" sandbox="allow-scripts allow-modals allow-forms allow-popups allow-same-origin"></iframe>
        </div>
      </div>

      <div class="console-container">
        <div class="section-header">
          <div class="section-title"><h2><svg viewBox="0 0 20 20" style="fill:#ccc"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 19V7H4v12h16zM4 5h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V7c0-1.1.9-2 2-2zm0-2h16V2H4v1z"/></svg> Console JS</h2></div>
          <button id="clearConsoleBtn" class="btn btn-tiny btn-dark">Pulisci</button>
        </div>
        <div id="console-output">
          <div style="color: #666; font-style: italic;">In attesa di log...</div>
        </div>
      </div>

    </div>
  </div>

  <div id="patchModal" class="modal-overlay">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:var(--brand-blue)">Patch Manuale Intelligente</h3>
        <button id="copyPatchPromptBtn" class="btn btn-tiny btn-purple" title="Copia istruzioni per AI">Copia Prompt x AI</button>
      </div>
      <p class="lead">Incolla il blocco vecchio (ricerca flessibile su spazi/maiuscole) e il nuovo codice.</p>
      
      <div style="margin-bottom:8px;">
        <label>Istruzioni / Contesto (Opzionale per Prompt AI):</label>
        <textarea id="patchInstructions" class="patch-area" style="height:45px; min-height:45px;" placeholder="Es. 'Cerca la funzione di Login e modificala per...'"></textarea>
      </div>
      
      <div class="switch-container" style="margin-bottom:12px;">
        <input type="checkbox" id="patchIncludeCodeToggle" checked>
        <label for="patchIncludeCodeToggle">Includi tutto il codice sorgente nel Prompt (Deseleziona se allegato)</label>
      </div>

      <div id="patchStatus" style="font-size: 13px; font-weight: bold; min-height: 20px; padding:4px 0;"></div>

      <div style="position:relative;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
          <label>Codice da trovare (Vecchio):</label>
          <button id="clearPatchFieldsBtn" class="btn btn-tiny btn-ghost" style="margin-bottom:2px;">Svuota Campi</button>
        </div>
        <textarea id="patchOld" class="patch-area" spellcheck="false" placeholder="Incolla qui il codice presente nell'editor..."></textarea>
      </div>
      <div>
        <label>Sostituisci con (Nuovo):</label>
        <textarea id="patchNew" class="patch-area" spellcheck="false" placeholder="Incolla qui il nuovo codice..."></textarea>
      </div>
      
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px">
        <button id="undoPatchBtn" class="btn btn-danger btn-tiny" style="display:none">Annulla Patch</button>
        <button id="closePatchBtn" class="btn btn-ghost">Chiudi</button>
        <button id="applyPatchBtn" class="btn btn-blue">Applica Patch</button>
      </div>
    </div>
  </div>

  <div id="aiModal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin:0; color:var(--brand-purple)">AI Multi-Patch Tool 3.3 (Secure)</h3>
      <p class="lead">Sistema immune a virgolette e markdown. Usa il formato @@@.</p>
      
      <div class="ai-step">
        <h4>1. Istruisci l'AI</h4>
        <textarea id="aiUserInstructions" class="patch-area" placeholder="Descrivi qui le modifiche che vuoi fare al codice (es. 'Cambia lo sfondo in rosso')..." style="height:60px; min-height:60px; margin-bottom:8px;"></textarea>
        
        <div class="switch-container">
          <input type="checkbox" id="includeCodeToggle" checked>
          <label for="includeCodeToggle">Includi il codice sorgente nel testo del Prompt (Deseleziona se alleghi file esterno)</label>
        </div>

        <button id="copyPromptBtn" class="btn btn-tiny btn-purple" style="width:100%">Copia Prompt Completo</button>
        <p style="font-size:12px; margin-top:6px; color:#666;">Il prompt includerà le tue istruzioni e un avviso di sicurezza assoluto per l'integrità.</p>
      </div>

      <div class="ai-step">
        <h4>2. Incolla Risposta AI <span style="font-size:11px; font-weight:normal; color:#888;">(o trascina testo qui)</span></h4>
        <textarea id="aiInput" class="patch-area" placeholder="Incolla qui la risposta dell'AI contenente i blocchi @@@ FIND @@@..." spellcheck="false"></textarea>
        <div id="aiLog" class="ai-log"></div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:0px">
        <button id="closeAiBtn" class="btn btn-ghost">Chiudi</button>
        <button id="applyAiBtn" class="btn btn-purple">Applica Modifiche AI</button>
      </div>
    </div>
  </div>

<script>
  var editor;
  var lastContentBeforePatch = null;
  const STORAGE_KEY = 'html_playground_content';
  
  window.onload = function() {
    editor = CodeMirror.fromTextArea(document.getElementById("code"), {
      mode: "htmlmixed",
      theme: "neo",
      lineNumbers: true,
      lineWrapping: true,
      autofocus: true
    });

    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved) {
      editor.setValue(saved);
    } else {
      editor.setValue(getDefaultTemplate());
    }

    editor.on("change", () => {
      saveToStorage();
      debouncedPreview();
    });

    updatePreview();
    setupResizer();
  };

  function getDefaultTemplate() {
    return `<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: sans-serif; padding: 20px; color: #333; }\n    h1 { color: #0146bc; }\n    .card { background: #eee; padding: 15px; border-radius: 8px; }\n  </style>\n</head>\n<body>\n  <h1>Ciao Mondo!</h1>\n  <div class="card">\n    <p>Prova a modificare questo testo o lo stile CSS.</p>\n    <button onclick="console.log('Click bottone: ' + new Date().toLocaleTimeString())">\n      Testa Console\n    </button>\n  </div>\n</body>\n</html>`;
  }

  function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, editor.getValue());
    const status = document.getElementById('saveStatus');
    status.textContent = 'Salvando...';
    setTimeout(() => status.textContent = 'Salvato', 500);
  }

  let debounceTimer;
  function debouncedPreview() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(updatePreview, 600); 
  }

  function updatePreview() {
    const previewFrame = document.getElementById('preview');
    if (!previewFrame) return;

    const code = editor.getValue();
    const consoleInterceptor = `\n<script>\n(function(){\n  function send(type, args){\n    try { window.parent.postMessage({source: 'playground-console', type: type, args: Array.from(args).map(a => String(a))}, '*'); } catch(e){}\n  }\n  const originalLog = console.log; console.log = function(...args){ originalLog.apply(console, args); send('log', args); };\n  const originalWarn = console.warn; console.warn = function(...args){ originalWarn.apply(console, args); send('warn', args); };\n  const originalError = console.error; console.error = function(...args){ originalError.apply(console, args); send('error', args); };\n  window.onerror = function(msg, url, line){ send('error', [msg + " (Line: " + line + ")"]); };\n})();\n<\/script>\n`;
    
    let finalHtml;
    const headRegex = /<head\b[^>]*>/i;
    
    if (headRegex.test(code)) {
      finalHtml = code.replace(headRegex, (match) => match + consoleInterceptor);
    } else {
      finalHtml = consoleInterceptor + code;
    }
    
    const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
    doc.open();
    doc.write(finalHtml);
    doc.close();
  }

  const consoleOutput = document.getElementById('console-output');
  window.addEventListener('message', (event) => {
    if (event.data && event.data.source === 'playground-console') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${event.data.type}`;
      entry.textContent = `[${new Date().toLocaleTimeString().split(' ')[0]}] > ${event.data.args.join(' ')}`;
      consoleOutput.appendChild(entry);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }
  });

  document.getElementById('clearConsoleBtn').onclick = () => consoleOutput.innerHTML = '';
  document.getElementById('refreshBtn').onclick = () => updatePreview();

  function showFeedback(btn, text) {
    const fb = btn.querySelector('.feedback');
    if(fb) {
      fb.textContent = text;
      btn.classList.add('loading');
      setTimeout(() => btn.classList.remove('loading'), 1500);
    }
  }

  document.getElementById('copyBtn').onclick = function() {
    navigator.clipboard.writeText(editor.getValue());
    showFeedback(this, 'Copiato!');
  };

  document.getElementById('pasteBtn').onclick = async function() {
    try {
      const text = await navigator.clipboard.readText();
      editor.setValue(text); // MODIFICATO: Sostituisce tutto invece di appendere
      showFeedback(this, 'Sostituito!');
    } catch (err) {
      console.error(err);
      alert('Impossibile accedere agli appunti. Consenti l\'accesso o usa Ctrl+V.');
    }
  };

  document.getElementById('newTabBtn').onclick = function() {
    const blob = new Blob([editor.getValue()], {type: 'text/html'});
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
  };

  document.getElementById('findBtn').onclick = function() {
    const query = document.getElementById('findInput').value;
    if(!query) return;
    let cursor = editor.getSearchCursor(query, editor.getCursor("to"));
    if (!cursor.findNext()) {
      cursor = editor.getSearchCursor(query, {line: 0, ch: 0});
      if (!cursor.findNext()) { showFeedback(this, 'Nessun risultato'); return; }
    }
    editor.setSelection(cursor.from(), cursor.to());
    const h = editor.getScrollInfo().clientHeight;
    const coords = editor.charCoords(cursor.from(), "local");
    editor.scrollTo(null, (coords.top + coords.bottom) / 2 - h / 2);
    editor.focus();
    showFeedback(this, 'Trovato');
  };

  document.getElementById('replaceBtn').onclick = function() {
    const query = document.getElementById('findInput').value;
    const replacement = document.getElementById('replaceInput').value;
    if(editor.getSelection() === query) {
      editor.replaceSelection(replacement);
      document.getElementById('findBtn').click();
    } else {
      document.getElementById('findBtn').click();
    }
  };

  // --- LOGICA MODALE PATCH MANUALE (AGGIORNATA) ---
  const patchModal = document.getElementById('patchModal');
  const patchStatus = document.getElementById('patchStatus');
  const undoPatchBtn = document.getElementById('undoPatchBtn');
  const patchOldInput = document.getElementById('patchOld');
  const patchNewInput = document.getElementById('patchNew');
  const patchInstructionsInput = document.getElementById('patchInstructions');
  const patchIncludeCodeToggle = document.getElementById('patchIncludeCodeToggle'); // NUOVO

  document.getElementById('patchBtn').onclick = () => {
    patchModal.style.display = 'flex';
    patchStatus.textContent = '';
    undoPatchBtn.style.display = 'none';
    patchInstructionsInput.value = '';
    patchOldInput.focus();
  };

  document.getElementById('closePatchBtn').onclick = () => patchModal.style.display = 'none';

  // Funzione helper per creare Regex "Fuzzy" (ignora spazi multipli/a capo e case sensitive)
  function createFuzzyRegex(text) {
    const escaped = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const pattern = escaped.replace(/\s+/g, '\\s+');
    return new RegExp(pattern, 'i'); 
  }

  patchOldInput.addEventListener('input', function() {
    const val = this.value.trim();
    if(!val) {
      patchStatus.textContent = '';
      return;
    }
    
    const currentContent = editor.getValue();
    const regex = createFuzzyRegex(val);

    if(regex.test(currentContent)) {
      patchStatus.style.color = "green";
      patchStatus.innerHTML = "✔ <b>Trovato!</b> Corrispondenza rilevata nel codice.";
    } else {
      patchStatus.style.color = "red";
      patchStatus.innerHTML = "✖ <b>Non trovato.</b> Verifica il codice incollato.";
    }
  });

  document.getElementById('clearPatchFieldsBtn').onclick = function() {
    patchOldInput.value = '';
    patchNewInput.value = '';
    patchInstructionsInput.value = '';
    patchStatus.textContent = '';
    patchOldInput.focus();
  };

  // 4) Copia Prompt AI specifico per Patch Manuale (AGGIORNATO CON TOGGLE)
  document.getElementById('copyPatchPromptBtn').onclick = function() {
    const instructions = patchInstructionsInput.value.trim();
    const includeCode = patchIncludeCodeToggle.checked;
    const currentCode = editor.getValue();

    let codeBlock = "";
    if(includeCode) {
        codeBlock = `CODICE SORGENTE COMPLETO:\n---\n${currentCode}\n---`;
    } else {
        codeBlock = `[[ IL CODICE SORGENTE È STATO ALLEGATO COME FILE ESTERNO ]]`;
    }

    const extraContext = instructions ? `\n\nCONTESTO/MODIFICHE RICHIESTE:\n${instructions}` : "";

    const promptText = `Ho bisogno di fare una modifica manuale precisa al codice.${extraContext}

${codeBlock}

Per favore analizza il codice e forniscimi SOLO due blocchi di codice per effettuare la sostituzione:
1. Il blocco ESATTO di codice originale presente nel sorgente che devo cercare (deve essere univoco, includi contesto se necessario).
2. Il NUOVO blocco di codice con cui devo sostituirlo.
Non aggiungere spiegazioni, solo i due blocchi.

[[ IMPORTANTE: NON MODIFICARE, RIDURRE O ALTERARE NESSUNA ALTRA PARTE DEL CODICE ]]`;
    
    navigator.clipboard.writeText(promptText);
    const originalText = this.textContent;
    this.textContent = "Copiato!";
    setTimeout(() => this.textContent = originalText, 2000);
  };
  
  document.getElementById('applyPatchBtn').onclick = function() {
    const oldCodeVal = patchOldInput.value.trim();
    const newCode = patchNewInput.value; 
    const currentContent = editor.getValue();
    
    if (oldCodeVal === "") {
      patchStatus.style.color = "red";
      patchStatus.textContent = "Errore: Inserisci il codice da trovare.";
      return;
    }

    const regex = createFuzzyRegex(oldCodeVal);

    if(regex.test(currentContent)) {
      lastContentBeforePatch = currentContent;
      const updatedContent = currentContent.replace(regex, newCode);
      editor.setValue(updatedContent);
      
      patchStatus.style.color = "green";
      patchStatus.innerHTML = "✔ <b>Patch applicata!</b> I campi sono stati svuotati.";
      undoPatchBtn.style.display = 'inline-flex';
      
      patchOldInput.value = ''; 
      patchNewInput.value = '';
      patchInstructionsInput.value = '';
    } else {
      patchStatus.style.color = "red";
      patchStatus.textContent = "✖ Blocco non trovato (nemmeno con ricerca flessibile).";
    }
  };

  undoPatchBtn.onclick = function() {
    if(lastContentBeforePatch !== null) {
      editor.setValue(lastContentBeforePatch);
      lastContentBeforePatch = null;
      patchStatus.style.color = "orange";
      patchStatus.textContent = "Operazione annullata.";
      this.style.display = 'none';
    }
  };

  // --- LOGICA NUOVA MODALE AI TOOLS 3.3 (Secure) ---
  const aiModal = document.getElementById('aiModal');
  const aiLog = document.getElementById('aiLog');

  document.getElementById('aiToolBtn').onclick = () => {
    aiModal.style.display = 'flex';
    aiLog.style.display = 'none';
    aiLog.innerHTML = '';
    document.getElementById('aiInput').value = '';
  };
  
  document.getElementById('closeAiBtn').onclick = () => aiModal.style.display = 'none';

  // 1. GENERATORE DI PROMPT 3.0 (Include istruzioni utente e avviso integrità)
  document.getElementById('copyPromptBtn').onclick = function() {
    const currentCode = editor.getValue();
    const userInstructions = document.getElementById('aiUserInstructions').value.trim();
    const includeCode = document.getElementById('includeCodeToggle').checked;
    
    let codeBlock = "";
    if(includeCode) {
        codeBlock = `CODICE SORGENTE:\n---\n${currentCode}\n---`;
    } else {
        codeBlock = `[[ IL CODICE SORGENTE È STATO ALLEGATO COME FILE ESTERNO ]]`;
    }

    const prompt = `Agisci come un esperto sviluppatore. Ho bisogno di modifiche al codice.

***MODIFICHE RICHIESTE***
${userInstructions ? userInstructions : "Attenzione: Nessuna istruzione specifica fornita. Migliora il codice esistente."}

***IMPERATIVO ASSOLUTO SULL'INTEGRITÀ***
Esegui SOLO ed ESCLUSIVAMENTE le modifiche richieste sopra.
NON modificare, NON ridurre, NON semplificare e NON rifattorizzare nessuna altra parte del codice.
L'applicazione deve rimanere identica tranne che per i punti specificati.

***FORMATO RISPOSTA (Obbligatorio)***
Usa SOLO questo formato personalizzato per la risposta. 
NON usare blocchi Markdown (\`\`\`) e NON usare JSON.

FORMATO RICHIESTO:
@@@ FIND @@@
[Qui incolla il codice esatto da sostituire]
@@@ REPLACE @@@
[Qui incolla il nuovo codice]
@@@ END @@@

Se ci sono più modifiche, ripeti il blocco.

${codeBlock}

Attendo le modifiche nel formato @@@ FIND @@@...`;

    navigator.clipboard.writeText(prompt);
    showFeedback(this, 'Prompt Copiato!');
    alert("Prompt copiato!\nInclude istruzioni, codice (o placeholder) e avviso di integrità severo.");
  };

  // 2. APPLICAZIONE PATCH 3.0 (SAFE BLOCKS)
  document.getElementById('applyAiBtn').onclick = function() {
    let rawInput = document.getElementById('aiInput').value;
    aiLog.style.display = 'block';
    aiLog.innerHTML = '';
    
    function log(msg, type='info') {
      const div = document.createElement('div');
      div.className = 'ai-log-item ' + (type === 'success' ? 'ai-log-success' : type === 'error' ? 'ai-log-error' : '');
      div.textContent = msg;
      aiLog.appendChild(div);
    }

    rawInput = rawInput.replace(/```html/gi, '').replace(/```/g, '');

    const regex = /@@@ FIND @@@\s*([\s\S]*?)\s*@@@ REPLACE @@@\s*([\s\S]*?)\s*@@@ END @@@/g;
    
    let match;
    let patches = [];
    while ((match = regex.exec(rawInput)) !== null) {
      patches.push({ find: match[1], replace: match[2] });
    }

    if (patches.length === 0) {
      log("ERRORE: Nessun blocco @@@ trovato. Assicurati di usare il prompt corretto.", "error");
      return;
    }

    let content = editor.getValue();
    let appliedCount = 0;
    let failedCount = 0;

    patches.forEach((patch, index) => {
      const findText = patch.find.replace(/^\n/, '').replace(/\n$/, ''); 
      const replaceText = patch.replace.replace(/^\n/, '').replace(/\n$/, '');

      if (content.includes(findText)) {
        content = content.replace(findText, replaceText);
        log(`Patch #${index+1}: Applicata correttamente.`, "success");
        appliedCount++;
      } else {
        if (content.includes(patch.find.trim())) {
           content = content.replace(patch.find.trim(), replaceText);
           log(`Patch #${index+1}: Applicata (con trim).`, "success");
           appliedCount++;
        } else {
           log(`Patch #${index+1}: FALLITA. Codice originale non trovato.`, "error");
           console.warn("Cercavo:\n", findText);
           failedCount++;
        }
      }
    });

    if (appliedCount > 0) {
      editor.setValue(content);
      log(`COMPLETATO: ${appliedCount} modifiche applicate.`, "success");
      saveToStorage();
    } else {
      log("Nessuna modifica applicata. Apri la console (F12) per i dettagli.", "error");
    }
  };

  const dropArea = document.getElementById('aiInput');
  dropArea.addEventListener('dragover', (e) => { e.stopPropagation(); e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; dropArea.style.borderColor = 'var(--brand-purple)'; });
  dropArea.addEventListener('dragleave', (e) => { dropArea.style.borderColor = 'var(--border-color)'; });
  dropArea.addEventListener('drop', (e) => {
    e.stopPropagation(); e.preventDefault();
    dropArea.style.borderColor = 'var(--border-color)';
    const file = e.dataTransfer.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (evt) => { document.getElementById('aiInput').value = evt.target.result; };
      reader.readAsText(file);
    }
  });

  document.getElementById('clearBtn').onclick = () => confirm('Cancellare tutto?') && editor.setValue('');
  
  const extSelect = document.getElementById('fileExtension');
  
  document.getElementById('downloadBtn').onclick = function() {
    const blob = new Blob([editor.getValue()], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    let extension = extSelect.value;
    a.download = (document.getElementById('filename').value || 'progetto') + extension;
    a.click();
  };

  document.getElementById('importBtn').onclick = () => document.getElementById('fileInput').click();
  document.getElementById('fileInput').onchange = (e) => {
    const file = e.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = (ev) => editor.setValue(ev.target.result);
      reader.readAsText(file);
    }
  };

  function setupResizer() {
    const resizer = document.getElementById('resizer'), ep = document.getElementById('paneEditor'), pp = document.getElementById('panePreview');
    let isResizing = false;
    resizer.onmousedown = (e) => { isResizing = true; document.body.style.cursor = 'col-resize'; e.preventDefault(); };
    document.onmousemove = (e) => {
      if (!isResizing) return;
      const w = document.getElementById('workspace').offsetWidth - e.clientX;
      if (e.clientX > 300 && w > 300) { ep.style.flex = '1'; pp.style.width = w + 'px'; pp.style.flex = 'none'; }
    };
    document.onmouseup = () => { isResizing = false; document.body.style.cursor = 'default'; editor.refresh(); };
  }
</script>
</body>
</html>
